generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum UserRole {
    user
    admin
}

enum AuthProvider {
    local
    google
    auth0
    oidc
}

enum AuditActorType {
    user
    api_key
    system
}

model User {
    id           String    @id @default(cuid())
    email        String    @unique
    passwordHash String?   @map("password_hash")
    role         UserRole  @default(user)
    createdAt    DateTime  @default(now()) @map("created_at")
    disabledAt   DateTime? @map("disabled_at")

    externalIdentities ExternalIdentity[]
    sessions           Session[]
    apiKeys            ApiKey[]
    links              Link[]

    @@map("users")
}

model ExternalIdentity {
    id              String       @id @default(cuid())
    userId          String       @map("user_id")
    provider        AuthProvider
    providerUserId  String       @map("provider_user_id")
    emailAtLinkTime String       @map("email_at_link_time")
    createdAt       DateTime     @default(now()) @map("created_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerUserId])
    @@index([userId])
    @@map("external_identities")
}

model Session {
    id               String    @id @default(cuid())
    userId           String    @map("user_id")
    refreshTokenHash String    @map("refresh_token_hash")
    createdAt        DateTime  @default(now()) @map("created_at")
    expiresAt        DateTime  @map("expires_at")
    revokedAt        DateTime? @map("revoked_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([expiresAt])
    @@map("sessions")
}

model ApiKey {
    id         String    @id @default(cuid())
    userId     String    @map("user_id")
    name       String
    keyPrefix  String    @map("key_prefix")
    keyHash    String    @map("key_hash")
    scopes     String[]
    createdAt  DateTime  @default(now()) @map("created_at")
    expiresAt  DateTime? @map("expires_at")
    revokedAt  DateTime? @map("revoked_at")
    lastUsedAt DateTime? @map("last_used_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([keyPrefix])
    @@map("api_keys")
}

model Link {
    id              String    @id @default(cuid())
    userId          String    @map("user_id")
    code            String    @unique
    originalUrl     String    @map("original_url")
    createdAt       DateTime  @default(now()) @map("created_at")
    expiresAt       DateTime? @map("expires_at")
    customAlias     String?   @unique @map("custom_alias")
    isActive        Boolean   @default(true) @map("is_active")
    createdByIpHash String?   @map("created_by_ip_hash")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([code])
    @@map("links")
}

model AuditLog {
    id            String         @id @default(cuid())
    actorType     AuditActorType @map("actor_type")
    actorUserId   String?        @map("actor_user_id")
    actorApiKeyId String?        @map("actor_api_key_id")
    action        String
    resourceType  String         @map("resource_type")
    resourceId    String?        @map("resource_id")
    ipHash        String?        @map("ip_hash")
    userAgent     String?        @map("user_agent")
    metadata      Json           @default("{}")
    createdAt     DateTime       @default(now()) @map("created_at")

    @@index([createdAt])
    @@index([actorType])
    @@index([resourceType])
    @@map("audit_logs")
}
